<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Space Dashboard</title>
  <!-- Leaflet map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="anonymous"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="anonymous"
  ></script>
  <!-- Satellite.js for propagating TLEs (Starlink) -->
  <script src="https://unpkg.com/satellite.js/dist/satellite.min.js"></script>
  <style>
    :root {
      --bg: #0b0f17;
      --bg-soft: #121826;
      --fg: #e6eefc;
      --muted: #9bb0cc;
      --accent: #5ad8ff;
      --danger: #ff5a5a;
      --ok: #5aff8e;
      --tile-border: rgba(255,255,255,0.7);
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      overflow: hidden; /* no page scrolling */
    }
    .topbar {
      height: 56px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 16px;
      padding: 0 16px;
      border-bottom: 1px solid var(--tile-border);
      background: linear-gradient(180deg, #0b0f17 0%, #0e1524 100%);
    }
    .title {
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 18px;
      text-align: center;
      white-space: nowrap;
    }
    .clock { font-variant-numeric: tabular-nums; font-size: 14px; color: var(--muted); }
    .clock.left { justify-self: start; }
    .clock.right { justify-self: end; }

    .grid {
      height: calc(100vh - 56px);
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 12px;
    }
    .tile {
      position: relative;
      background: var(--bg-soft);
      border: 1px solid var(--tile-border);
      border-radius: 14px;
      overflow: hidden; /* keep within tile */
      display: flex;
      flex-direction: column;
    }
    .tile h2 {
      margin: 0;
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 700;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
    }
    .tile-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
    }
    .subtle { color: var(--muted); font-size: 12px; }
    .coords { padding: 8px 12px; font-size: 13px; color: var(--muted); border-top: 1px dashed rgba(255,255,255,0.1); }
    .map { width: 100%; height: 100%; }
    .map-wrap { flex: 1; min-height: 0; }

    /* Lists */
    .list { padding: 8px 12px 12px; overflow: hidden; display: flex; flex-direction: column; gap: 8px; }
    .launch { padding: 10px 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; }
    .launch .when { font-variant-numeric: tabular-nums; color: var(--accent); font-size: 12px; }
    .launch .name { font-weight: 700; font-size: 14px; margin-top: 4px; }
    .launch .meta { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .statusbar { position: absolute; bottom: 8px; right: 12px; font-size: 11px; color: var(--muted); }

    /* Controls */
    .controls { display: flex; align-items: center; gap: 10px; }
    select, button {
      background: rgba(255,255,255,0.06);
      color: var(--fg);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
    }

    /* Handle very small screens gracefully (still no page scroll) */
    @media (max-width: 950px) {
      .grid { grid-template-columns: 1fr; grid-template-rows: repeat(4, 1fr); }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="clock left" id="clock-et">—</div>
    <div class="title">SPACE DASHBOARD</div>
    <div class="clock right" id="clock-utc">—</div>
  </div>

  <div class="grid">
    <!-- ISS Position -->
    <section class="tile" id="iss-tile">
      <h2>ISS Position <span class="subtle" id="iss-upd">(updating…)</span></h2>
      <div class="map-wrap"><div id="iss-map" class="map"></div></div>
      <div class="coords" id="iss-coords">Lat —, Lon —, Alt — km, Vel — km/s</div>
    </section>

    <!-- Starlink Position -->
    <section class="tile" id="starlink-tile">
      <div class="tile-header">
        <h2 style="margin:0">Starlink Position</h2>
        <div class="controls">
          <label for="starlink-select" class="subtle">Satellite</label>
          <select id="starlink-select" title="Choose a Starlink satellite"></select>
          <button id="reload-tles" title="Reload latest TLEs">Reload TLEs</button>
        </div>
      </div>
      <div class="map-wrap"><div id="starlink-map" class="map"></div></div>
      <div class="coords" id="starlink-coords">Lat —, Lon —, Alt — km</div>
    </section>

    <!-- NASA Launches -->
    <section class="tile" id="nasa-tile">
      <h2>Upcoming NASA‑related Launches</h2>
      <div class="list" id="nasa-list"></div>
      <div class="statusbar" id="nasa-status"></div>
    </section>

    <!-- SpaceX Launches -->
    <section class="tile" id="spx-tile">
      <h2>Upcoming SpaceX Launches</h2>
      <div class="list" id="spx-list"></div>
      <div class="statusbar" id="spx-status"></div>
    </section>
  </div>

<script>
  /*******************
   * CLOCKS (ET & UTC)
   *******************/
  const etClock = document.getElementById('clock-et');
  const utcClock = document.getElementById('clock-utc');
  const ET_ZONE = 'America/New_York'; // auto DST; shows EDT/EST
  function fmtClock(date, zone) {
    return new Intl.DateTimeFormat(undefined, {
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: false, timeZone: zone, timeZoneName: 'short'
    }).format(date);
  }
  function tickClocks() {
    const now = new Date();
    etClock.textContent = 'ET ' + fmtClock(now, ET_ZONE);
    utcClock.textContent = 'UTC ' + fmtClock(now, 'UTC');
  }
  tickClocks(); setInterval(tickClocks, 1000);

  /*******************
   * MAPS (Leaflet)
   *******************/
  const osmAttribution = '&copy; OpenStreetMap contributors';
  const tileLayerUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

  // ISS Map
  const issMap = L.map('iss-map', { zoomControl: false, worldCopyJump: true }).setView([0,0], 3);
  L.tileLayer(tileLayerUrl, { attribution: osmAttribution }).addTo(issMap);
  const issMarker = L.circleMarker([0,0], { radius: 6, color: '#5ad8ff', weight: 2, fillOpacity: 0.8 }).addTo(issMap);
  const issPath = L.polyline([], { color: '#5ad8ff', weight: 1, opacity: 0.6 }).addTo(issMap);

  // Starlink Map
  const slMap = L.map('starlink-map', { zoomControl: false, worldCopyJump: true }).setView([0,0], 3);
  L.tileLayer(tileLayerUrl, { attribution: osmAttribution }).addTo(slMap);
  const slMarker = L.circleMarker([0,0], { radius: 5, color: '#5aff8e', weight: 2, fillOpacity: 0.8 }).addTo(slMap);

  /*******************
   * ISS POSITION
   * Source: wheretheiss.at (https://wheretheiss.at/w/developer)
   *******************/
  const ISS_API = 'https://api.wheretheiss.at/v1/satellites/25544';
  const issCoordsEl = document.getElementById('iss-coords');
  const issUpdEl = document.getElementById('iss-upd');
  let issTrail = [];
  async function updateISS() {
    try {
      const res = await fetch(ISS_API, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const d = await res.json();
      const lat = d.latitude, lon = d.longitude, alt = d.altitude, vel = d.velocity; // km, km/s
      issMarker.setLatLng([lat, lon]);
      issTrail.push([lat, lon]);
      if (issTrail.length > 500) issTrail.shift();
      issPath.setLatLngs(issTrail);
      issCoordsEl.textContent = `Lat ${lat.toFixed(2)}°, Lon ${lon.toFixed(2)}°, Alt ${alt.toFixed(0)} km, Vel ${vel.toFixed(2)} km/s`;
      issUpdEl.textContent = '(live)';
      // Keep the ISS roughly centered without excessive jumping
      const b = issMap.getBounds();
      if (!b.contains([lat, lon])) issMap.panTo([lat, lon], { animate: true });
    } catch (e) {
      issUpdEl.textContent = '(offline)';
    }
  }
  updateISS();
  setInterval(updateISS, 5000);

  /*******************
   * STARLINK POSITION (choose any satellite from fresh TLEs)
   * Source: CelesTrak Starlink TLEs
   *******************/
  const STARLINK_TLE_URL = 'https://celestrak.org/NORAD/elements/gp.php?GROUP=starlink&FORMAT=tle';
  const slSelect = document.getElementById('starlink-select');
  const slCoordsEl = document.getElementById('starlink-coords');
  const reloadBtn = document.getElementById('reload-tles');
  let starlinkTLEs = [];
  let currentSat = null; // { name, line1, line2, satrec }

  function parseTLE(text) {
    const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    const items = [];
    for (let i = 0; i < lines.length - 2; i += 3) {
      items.push({ name: lines[i], line1: lines[i + 1], line2: lines[i + 2] });
    }
    return items;
  }
  function loadSelect() {
    slSelect.innerHTML = '';
    const sample = starlinkTLEs.slice(0, 100); // cap to 100 items for UI
    for (const item of sample) {
      const opt = document.createElement('option');
      opt.value = item.name;
      opt.textContent = item.name;
      slSelect.appendChild(opt);
    }
    if (sample.length) setCurrentByName(sample[0].name);
  }
  function setCurrentByName(name) {
    const item = starlinkTLEs.find(x => x.name === name);
    if (!item) return;
    currentSat = {
      name: item.name,
      line1: item.line1,
      line2: item.line2,
      satrec: satellite.twoline2satrec(item.line1, item.line2)
    };
  }
  async function fetchTLEs() {
    try {
      const res = await fetch(STARLINK_TLE_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      starlinkTLEs = parseTLE(text);
      loadSelect();
    } catch (e) {
      console.warn('TLE fetch failed, using fallback', e);
      // Fallback example (may be stale)
      const fallback = `STARLINK-30000\n1 70000U 00000A   24220.50000000  .00010000  00000-0  10000-3 0  9990\n2 70000  53.0000  10.0000 0002000  60.0000 300.0000 15.50000000    10`;
      starlinkTLEs = parseTLE(fallback);
      loadSelect();
    }
  }

  slSelect.addEventListener('change', () => setCurrentByName(slSelect.value));
  reloadBtn.addEventListener('click', fetchTLEs);

  function updateStarlink() {
    if (!currentSat) return;
    const now = new Date();
    const gmst = satellite.gstime(now);
    const posVel = satellite.propagate(currentSat.satrec, now);
    if (!posVel.position) return;
    const positionGd = satellite.eciToGeodetic(posVel.position, gmst);
    const lat = satellite.degreesLat(positionGd.latitude);
    const lon = satellite.degreesLong(positionGd.longitude);
    const alt = positionGd.height * 6371; // Earth radii -> km approx
    slMarker.setLatLng([lat, lon]);
    slCoordsEl.textContent = `Lat ${lat.toFixed(2)}°, Lon ${lon.toFixed(2)}°, Alt ${alt.toFixed(0)} km — ${currentSat.name}`;
    const b = slMap.getBounds();
    if (!b.contains([lat, lon])) slMap.panTo([lat, lon]);
  }
  setInterval(updateStarlink, 1500);
  fetchTLEs();

  /*******************
   * LAUNCHES (Launch Library 2)
   * https://ll.thespacedevs.com/2.2.0/launch/upcoming/
   *******************/
  const LL2_URL = 'https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=60&ordering=net';
  const nasaList = document.getElementById('nasa-list');
  const spxList  = document.getElementById('spx-list');
  const nasaStatus = document.getElementById('nasa-status');
  const spxStatus  = document.getElementById('spx-status');

  function clearChildren(el) { while (el.firstChild) el.removeChild(el.firstChild); }

  function formatWhen(netIso) {
    // Show both ET and UTC (short). If NET unknown, show TBD.
    if (!netIso) return 'TBD';
    const d = new Date(netIso);
    const et = new Intl.DateTimeFormat(undefined, { timeZone: ET_ZONE, month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false }).format(d);
    const utc = new Intl.DateTimeFormat(undefined, { timeZone: 'UTC', hour:'2-digit', minute:'2-digit', hour12:false }).format(d);
    return `${et} ET · ${utc} UTC`;
  }

  function mkLaunchItem(l) {
    const li = document.createElement('div'); li.className = 'launch';
    const when = document.createElement('div'); when.className = 'when'; when.textContent = 'NET ' + formatWhen(l.net);
    const name = document.createElement('div'); name.className = 'name'; name.textContent = l.name || (l.mission && l.mission.name) || 'Untitled Mission';
    const meta = document.createElement('div'); meta.className = 'meta';
    const vehicle = l.rocket && l.rocket.configuration ? l.rocket.configuration.name : (l.launch_service_provider && l.launch_service_provider.name) || '';
    const pad = l.pad ? `${l.pad.name || ''}${l.pad.location ? ' — ' + l.pad.location.name : ''}` : '';
    meta.textContent = [vehicle, pad].filter(Boolean).join(' • ');
    li.append(when, name, meta);
    return li;
  }

  function isSpaceX(l) {
    return (l.launch_service_provider && /spacex/i.test(l.launch_service_provider.name))
           || (/spacex/i.test(l.name || ''));
  }

  function isNASARelated(l) {
    const fields = [l.name, l.mission && l.mission.name, l.mission && l.mission.description]
      .filter(Boolean).join(' \n ');
    const nasaInText = /\bNASA\b/i.test(fields);
    const byLsp = (l.launch_service_provider && /nasa/i.test(l.launch_service_provider.name));
    let viaProgram = false;
    if (Array.isArray(l.program)) {
      viaProgram = l.program.some(p => /nasa/i.test(p.name || '') || (p.agencies || []).some(a => /nasa/i.test(a.name || '')));
    }
    // Also check mission agencies if present
    let viaMissionAgencies = false;
    if (l.mission && Array.isArray(l.mission.agencies)) {
      viaMissionAgencies = l.mission.agencies.some(a => /nasa/i.test(a.name || ''));
    }
    return nasaInText || byLsp || viaProgram || viaMissionAgencies;
  }

  async function loadLaunches() {
    try {
      const res = await fetch(LL2_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const launches = data.results || [];
      const spx = launches.filter(isSpaceX).slice(0, 6);
      const nasa = launches.filter(isNASARelated).slice(0, 6);
      clearChildren(spxList); clearChildren(nasaList);
      if (!spx.length) spxList.innerHTML = '<div class="subtle">None found in feed.</div>';
      if (!nasa.length) nasaList.innerHTML = '<div class="subtle">None found in feed.</div>';
      spx.forEach(l => spxList.appendChild(mkLaunchItem(l)));
      nasa.forEach(l => nasaList.appendChild(mkLaunchItem(l)));
      const ts = new Date();
      spxStatus.textContent = 'Updated ' + ts.toLocaleTimeString();
      nasaStatus.textContent = 'Updated ' + ts.toLocaleTimeString();
    } catch (e) {
      spxList.innerHTML = '<div class="subtle">Failed to load.</div>';
      nasaList.innerHTML = '<div class="subtle">Failed to load.</div>';
    }
  }
  loadLaunches();
  setInterval(loadLaunches, 15 * 60 * 1000); // refresh every 15 minutes

</script>
</body>
</html>
